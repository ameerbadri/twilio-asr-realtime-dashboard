<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for lib/network.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">lib/</a> network.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">17.76% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>19/107</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">8.89% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>4/45</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">37.5% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>9/24</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">5.95% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>5/84</span>
      </div>
      <div class='fl pad1y'>
        <span class="strong">14 statements, 9 functions, 4 branches</span>
        <span class="quiet">Ignored</span>  &nbsp;&nbsp;&nbsp;&nbsp;
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">"use strict";
<span class="cstat-no" title="statement not covered" >O</span>bject.defineProperty(exports, "__esModule", { value: true });
<span class="cstat-no" title="statement not covered" >c</span>onst uuid = require("uuid");
<span class="cstat-no" title="statement not covered" >c</span>onst logger_1 = require("./logger");
<span class="cstat-no" title="statement not covered" >c</span>onst syncerror_1 = require("./syncerror");
<span class="cstat-no" title="statement not covered" >c</span>onst syncNetworkError_1 = require("./syncNetworkError");
<span class="cstat-no" title="statement not covered" >c</span>onst operation_retrier_1 = require("operation-retrier");
<span class="cstat-no" title="statement not covered" >c</span>onst twilio_transport_1 = require("twilio-transport");
<span class="cstat-no" title="statement not covered" >c</span>onst MINIMUM_RETRY_DELAY = 4000;
<span class="cstat-no" title="statement not covered" >c</span>onst MAXIMUM_RETRY_DELAY = 60000;
<span class="cstat-no" title="statement not covered" >c</span>onst MAXIMUM_ATTEMPTS_TIME = 90000;
<span class="cstat-no" title="statement not covered" >c</span>onst RETRY_DELAY_RANDOMNESS = 0.2;
<span class="fstat-no" title="function not covered" >function messageFromErrorBody(trasportError) {</span>
<span class="cstat-no" title="statement not covered" >    if (trasportError.body) {</span>
<span class="cstat-no" title="statement not covered" >        if (trasportError.body.message) {</span>
<span class="cstat-no" title="statement not covered" >            r</span>eturn trasportError.body.message;
        }
    }
<span class="cstat-no" title="statement not covered" >    s</span>witch (trasportError.status) {
        case 429:
<span class="cstat-no" title="statement not covered" >            r</span>eturn 'Throttled by server';
        case 404:
<span class="cstat-no" title="statement not covered" >            r</span>eturn 'Not found from server';
        default:
<span class="cstat-no" title="statement not covered" >            r</span>eturn 'Error from server';
    }
}
<span class="fstat-no" title="function not covered" >function codeFromErrorBody(trasportError) {</span>
<span class="cstat-no" title="statement not covered" >    if (trasportError.body) {</span>
<span class="cstat-no" title="statement not covered" >        r</span>eturn trasportError.body.code;
    }
<span class="cstat-no" title="statement not covered" >    r</span>eturn 0;
}
<span class="fstat-no" title="function not covered" >function mapTransportError(transportError) {</span>
<span class="cstat-no" title="statement not covered" >    if (transportError.status === 409) {</span>
<span class="cstat-no" title="statement not covered" >        r</span>eturn new syncNetworkError_1.SyncNetworkError(messageFromErrorBody(transportError), transportError.status, codeFromErrorBody(transportError), transportError.body);
    }
    else <span class="cstat-no" title="statement not covered" >if (transportError.status) {</span>
<span class="cstat-no" title="statement not covered" >        r</span>eturn new syncerror_1.SyncError(messageFromErrorBody(transportError), transportError.status, codeFromErrorBody(transportError));
    }
    else <span class="cstat-no" title="statement not covered" >if (transportError instanceof twilio_transport_1.TwilsockUnavailableError) {</span>
<span class="cstat-no" title="statement not covered" >        r</span>eturn transportError;
    }
    else {
<span class="cstat-no" title="statement not covered" >        r</span>eturn new syncerror_1.SyncError(transportError.message, 0, 0);
    }
}
/**
 * @classdesc Incapsulates network operations to make it possible to add some optimization/caching strategies
 */
class Network {
<span class="fstat-no" title="function not covered" >    constructor(productId, clientInfo, config, transport) <span class="cstat-no" title="statement not covered" >{</span></span>
<span class="cstat-no" title="statement not covered" >        t</span>his.productId = productId;
<span class="cstat-no" title="statement not covered" >        t</span>his.clientInfo = clientInfo;
<span class="cstat-no" title="statement not covered" >        t</span>his.config = config;
<span class="cstat-no" title="statement not covered" >        t</span>his.transport = transport;
    }
    createHeaders() {
<span class="cstat-no" title="statement not covered" >        r</span>eturn {
            'Content-Type': 'application/json',
            'Twilio-Sync-Client-Info': JSON.stringify(this.clientInfo),
            'Twilio-Request-Id': 'RQ' + uuid.v4().replace(/-/g, ''),
            'X-Twilio-Product-Id': this.productId,
            'X-Twilio-Token': this.config.token
        };
    }
    backoffConfig() {
<span class="cstat-no" title="statement not covered" >        r</span>eturn Object.assign({ min: MINIMUM_RETRY_DELAY,
            max: MAXIMUM_RETRY_DELAY,
            maxAttemptsTime: MAXIMUM_ATTEMPTS_TIME,
            randomness: RETRY_DELAY_RANDOMNESS }, this.config.backoffConfig);
    }
    executeWithRetry(request, retryWhenThrottled = true) <span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" >{</span></span>
<span class="cstat-no" title="statement not covered" >        r</span>eturn new Promise(<span class="fstat-no" title="function not covered" >(resolve, reject) =&gt; {</span>
<span class="cstat-no" title="statement not covered" >            l</span>et codesToRetryOn = [502, 503, 504];
<span class="cstat-no" title="statement not covered" >            if (retryWhenThrottled) {</span>
<span class="cstat-no" title="statement not covered" >                c</span>odesToRetryOn.push(429);
            }
<span class="cstat-no" title="statement not covered" >            l</span>et retrier = new operation_retrier_1.default(this.backoffConfig());
<span class="cstat-no" title="statement not covered" >            r</span>etrier.on('attempt', <span class="fstat-no" title="function not covered" >() =&gt; {</span>
<span class="cstat-no" title="statement not covered" >                r</span>equest()
                    .then(<span class="cstat-no" title="statement not covered" ><span class="fstat-no" title="function not covered" >r</span></span>esult =&gt; retrier.succeeded(result))
                    .catch(<span class="fstat-no" title="function not covered" >err =&gt; {</span>
<span class="cstat-no" title="statement not covered" >                    if (codesToRetryOn.includes(err.status)) {</span>
<span class="cstat-no" title="statement not covered" >                        l</span>et delayOverride = parseInt(err.headers ? err.headers['Retry-After'] : null);
<span class="cstat-no" title="statement not covered" >                        r</span>etrier.failed(mapTransportError(err), isNaN(delayOverride) ? null : delayOverride * 1000);
                    }
                    else <span class="cstat-no" title="statement not covered" >if (err.message === 'Twilsock disconnected') {</span>
                        // Ugly hack. We must make a proper exceptions for twilsock
<span class="cstat-no" title="statement not covered" >                        r</span>etrier.failed(mapTransportError(err));
                    }
                    else <span class="cstat-no" title="statement not covered" >if (err.message &amp;&amp; err.message.indexOf('Twilsock: request timeout') !== -1) {</span>
                        // Ugly hack. We must make a proper exceptions for twilsock
<span class="cstat-no" title="statement not covered" >                        r</span>etrier.failed(mapTransportError(err));
                    }
                    else {
                        // Fatal error
<span class="cstat-no" title="statement not covered" >                        r</span>etrier.removeAllListeners();
<span class="cstat-no" title="statement not covered" >                        r</span>etrier.cancel();
<span class="cstat-no" title="statement not covered" >                        r</span>eject(mapTransportError(err));
                    }
                });
            });
<span class="cstat-no" title="statement not covered" >            r</span>etrier.on('succeeded', <span class="fstat-no" title="function not covered" >result =&gt; {</span> <span class="cstat-no" title="statement not covered" >r</span>esolve(result); });
<span class="cstat-no" title="statement not covered" >            r</span>etrier.on('cancelled', <span class="cstat-no" title="statement not covered" ><span class="fstat-no" title="function not covered" >e</span></span>rr =&gt; reject(mapTransportError(err)));
<span class="cstat-no" title="statement not covered" >            r</span>etrier.on('failed', <span class="cstat-no" title="statement not covered" ><span class="fstat-no" title="function not covered" >e</span></span>rr =&gt; reject(mapTransportError(err)));
<span class="cstat-no" title="statement not covered" >            r</span>etrier.start();
        });
    }
    /**
     * Make a GET request by given URI
     * @Returns Promise&lt;Response&gt; Result of successful get request
     */
    get(uri) <span class="cstat-no" title="statement not covered" >{</span>
<span class="cstat-no" title="statement not covered" >        l</span>et headers = this.createHeaders();
<span class="cstat-no" title="statement not covered" >        l</span>ogger_1.default.debug('GET', uri, 'ID:', headers['Twilio-Request-Id']);
<span class="cstat-no" title="statement not covered" >        r</span>eturn this.executeWithRetry(<span class="cstat-no" title="statement not covered" ><span class="fstat-no" title="function not covered" >(</span></span>) =&gt; this.transport.get(uri, headers), true);
    }
    post(uri, body, revision, twilsockOnly) <span class="cstat-no" title="statement not covered" >{</span>
<span class="cstat-no" title="statement not covered" >        l</span>et headers = this.createHeaders();
<span class="cstat-no" title="statement not covered" >        if (typeof revision !== 'undefined' &amp;&amp; revision !== null) {</span>
<span class="cstat-no" title="statement not covered" >            h</span>eaders['If-Match'] = revision;
        }
<span class="cstat-no" title="statement not covered" >        l</span>ogger_1.default.debug('POST', uri, 'ID:', headers['Twilio-Request-Id']);
<span class="cstat-no" title="statement not covered" >        r</span>eturn this.executeWithRetry(<span class="cstat-no" title="statement not covered" ><span class="fstat-no" title="function not covered" >(</span></span>) =&gt; this.transport.post(uri, headers, body, twilsockOnly), false);
    }
    put(uri, body, revision) <span class="cstat-no" title="statement not covered" >{</span>
<span class="cstat-no" title="statement not covered" >        l</span>et headers = this.createHeaders();
<span class="cstat-no" title="statement not covered" >        if (typeof revision !== 'undefined' &amp;&amp; revision !== null) {</span>
<span class="cstat-no" title="statement not covered" >            h</span>eaders['If-Match'] = revision;
        }
<span class="cstat-no" title="statement not covered" >        l</span>ogger_1.default.debug('PUT', uri, 'ID:', headers['Twilio-Request-Id']);
<span class="cstat-no" title="statement not covered" >        r</span>eturn this.executeWithRetry(<span class="cstat-no" title="statement not covered" ><span class="fstat-no" title="function not covered" >(</span></span>) =&gt; this.transport.put(uri, headers, body), false);
    }
    delete(uri) <span class="cstat-no" title="statement not covered" >{</span>
<span class="cstat-no" title="statement not covered" >        l</span>et headers = this.createHeaders();
<span class="cstat-no" title="statement not covered" >        l</span>ogger_1.default.debug('DELETE', uri, 'ID:', headers['Twilio-Request-Id']);
<span class="cstat-no" title="statement not covered" >        r</span>eturn this.executeWithRetry(<span class="cstat-no" title="statement not covered" ><span class="fstat-no" title="function not covered" >(</span></span>) =&gt; this.transport.delete(uri, headers), false);
    }
}
<span class="cstat-no" title="statement not covered" >e</span>xports.Network = Network;
<span class="cstat-no" title="statement not covered" >e</span>xports.default = Network;
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Thu Nov 09 2017 15:52:06 GMT+0200 (EET)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
